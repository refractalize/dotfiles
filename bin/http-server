#!/usr/bin/env pogo

express = require 'express'
fs = require 'fs'
argv = require 'optimist'.default 'p' '4000'.alias 'p' 'port'.argv
browserify = require 'browserify-middleware'

serveDirectory (dir) =
    app = express ()
    app.use (express.logger ())
    browserDir = "#(dir)/browser"
    console.log (browserDir)
    if (fs.existsSync (browserDir))
      app.use (browserify (browserDir, {transform = ['pogoify'], extensions = ['.pogo'], grep = r/(\.pogo|\.js|\.less)$/}))
    else
      console.log "tip: put browserify content in dir #(browserDir)"

    app.use (express.static (dir))
    app.listen (parseInt (argv.p))

dir = process.cwd ()
serveDirectory (dir)
console.log "serving #(dir) at http://localhost:#(argv.p)/"
